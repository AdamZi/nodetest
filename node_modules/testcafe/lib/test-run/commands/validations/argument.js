"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.urlsArgument = exports.setCookiesArgument = exports.cookiesArgument = exports.functionArgument = exports.screenshotPathArgument = exports.resizeWindowDeviceArgument = exports.stringOrStringArrayArgument = exports.urlArgument = exports.nullableStringArgument = exports.nonEmptyStringArgument = exports.stringArgument = exports.actionOptions = exports.actionRoleArgument = exports.setSpeedArgument = exports.booleanArgument = exports.positiveIntegerArgument = exports.integerArgument = void 0;
const device_specs_1 = require("device-specs");
const marker_symbol_1 = __importDefault(require("../../../role/marker-symbol"));
const factories_1 = require("./factories");
const test_run_1 = require("../../../errors/test-run");
const url_1 = require("url");
const test_page_url_1 = require("../../../api/test-page-url");
const check_file_path_1 = __importDefault(require("../../../utils/check-file-path"));
const lodash_1 = require("lodash");
// Validators
exports.integerArgument = factories_1.createIntegerValidator(test_run_1.ActionIntegerArgumentError);
exports.positiveIntegerArgument = factories_1.createPositiveIntegerValidator(test_run_1.ActionPositiveIntegerArgumentError);
exports.booleanArgument = factories_1.createBooleanValidator(test_run_1.ActionBooleanArgumentError);
exports.setSpeedArgument = factories_1.createSpeedValidator(test_run_1.SetTestSpeedArgumentError);
function actionRoleArgument(name, val) {
    if (!val || !val[marker_symbol_1.default])
        throw new test_run_1.ActionRoleArgumentError(name, typeof val);
}
exports.actionRoleArgument = actionRoleArgument;
function actionOptions(name, val) {
    const type = typeof val;
    if (type !== 'object' && val !== null && val !== void 0)
        throw new test_run_1.ActionOptionsTypeError(type);
}
exports.actionOptions = actionOptions;
function stringArgument(argument, val, createError) {
    if (!createError)
        createError = actualValue => new test_run_1.ActionStringArgumentError(argument, actualValue);
    const type = typeof val;
    if (type !== 'string')
        throw createError(type);
}
exports.stringArgument = stringArgument;
function nonEmptyStringArgument(argument, val, createError) {
    if (!createError)
        createError = actualValue => new test_run_1.ActionStringArgumentError(argument, actualValue);
    stringArgument(argument, val, createError);
    if (!val.length)
        throw createError('""');
}
exports.nonEmptyStringArgument = nonEmptyStringArgument;
function nullableStringArgument(argument, val) {
    const type = typeof val;
    if (type !== 'string' && val !== null)
        throw new test_run_1.ActionNullableStringArgumentError(argument, type);
}
exports.nullableStringArgument = nullableStringArgument;
function urlArgument(name, val) {
    nonEmptyStringArgument(name, val);
    test_page_url_1.assertPageUrl(val.trim(), 'navigateTo');
}
exports.urlArgument = urlArgument;
function stringOrStringArrayArgument(argument, val) {
    const type = typeof val;
    if (type === 'string') {
        if (!val.length)
            throw new test_run_1.ActionStringOrStringArrayArgumentError(argument, '""');
    }
    else if (Array.isArray(val)) {
        if (!val.length)
            throw new test_run_1.ActionStringOrStringArrayArgumentError(argument, '[]');
        const validateElement = elementIndex => nonEmptyStringArgument(argument, val[elementIndex], actualValue => new test_run_1.ActionStringArrayElementError(argument, actualValue, elementIndex));
        for (let i = 0; i < val.length; i++)
            validateElement(i);
    }
    else
        throw new test_run_1.ActionStringOrStringArrayArgumentError(argument, type);
}
exports.stringOrStringArrayArgument = stringOrStringArrayArgument;
function resizeWindowDeviceArgument(name, val) {
    nonEmptyStringArgument(name, val);
    if (!device_specs_1.isValidDeviceName(val))
        throw new test_run_1.ActionUnsupportedDeviceTypeError(name, val);
}
exports.resizeWindowDeviceArgument = resizeWindowDeviceArgument;
function screenshotPathArgument(name, val) {
    nonEmptyStringArgument(name, val);
    const forbiddenCharsList = check_file_path_1.default(val);
    if (forbiddenCharsList.length)
        throw new test_run_1.ForbiddenCharactersInScreenshotPathError(val, forbiddenCharsList);
}
exports.screenshotPathArgument = screenshotPathArgument;
function functionArgument(name, val) {
    if (typeof val !== 'function')
        throw new test_run_1.ActionFunctionArgumentError(name, val);
}
exports.functionArgument = functionArgument;
function isValidCookie(cookie) {
    return !!cookie && (typeof cookie === 'object' || typeof cookie === 'string');
}
function cookiesArgument(name, val) {
    const cookiesLength = val.length;
    for (const [i, value] of val.entries()) {
        if (!isValidCookie(value)) {
            throw cookiesLength === 1
                ? new test_run_1.ActionCookieArgumentError()
                : new test_run_1.ActionCookieArgumentsError(i);
        }
    }
}
exports.cookiesArgument = cookiesArgument;
function setCookiesArgument(name, val) {
    if (!val.length)
        throw new test_run_1.ActionRequiredCookieArguments();
    cookiesArgument(name, val);
}
exports.setCookiesArgument = setCookiesArgument;
function isValidUrl(url) {
    try {
        return new url_1.URL(url) && true;
    }
    catch (_a) {
        return false;
    }
}
function urlsArgument(name, val) {
    const castVal = lodash_1.castArray(val);
    for (const [i, value] of castVal.entries()) {
        if (!isValidUrl(value)) {
            throw castVal.length === 1
                ? new test_run_1.ActionUrlCookieArgumentError()
                : new test_run_1.ActionUrlsCookieArgumentError(i);
        }
    }
}
exports.urlsArgument = urlsArgument;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXJndW1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvdGVzdC1ydW4vY29tbWFuZHMvdmFsaWRhdGlvbnMvYXJndW1lbnQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsK0NBQWlEO0FBQ2pELGdGQUEyRDtBQUUzRCwyQ0FLcUI7QUFFckIsdURBbUJrQztBQUVsQyw2QkFBMEI7QUFDMUIsOERBQTJEO0FBQzNELHFGQUEyRDtBQUMzRCxtQ0FBbUM7QUFHbkMsYUFBYTtBQUNBLFFBQUEsZUFBZSxHQUFXLGtDQUFzQixDQUFDLHFDQUEwQixDQUFDLENBQUM7QUFDN0UsUUFBQSx1QkFBdUIsR0FBRywwQ0FBOEIsQ0FBQyw2Q0FBa0MsQ0FBQyxDQUFDO0FBQzdGLFFBQUEsZUFBZSxHQUFXLGtDQUFzQixDQUFDLHFDQUEwQixDQUFDLENBQUM7QUFDN0UsUUFBQSxnQkFBZ0IsR0FBVSxnQ0FBb0IsQ0FBQyxvQ0FBeUIsQ0FBQyxDQUFDO0FBR3ZGLFNBQWdCLGtCQUFrQixDQUFFLElBQUksRUFBRSxHQUFHO0lBQ3pDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsdUJBQWdCLENBQUM7UUFDOUIsTUFBTSxJQUFJLGtDQUF1QixDQUFDLElBQUksRUFBRSxPQUFPLEdBQUcsQ0FBQyxDQUFDO0FBQzVELENBQUM7QUFIRCxnREFHQztBQUVELFNBQWdCLGFBQWEsQ0FBRSxJQUFJLEVBQUUsR0FBRztJQUNwQyxNQUFNLElBQUksR0FBRyxPQUFPLEdBQUcsQ0FBQztJQUV4QixJQUFJLElBQUksS0FBSyxRQUFRLElBQUksR0FBRyxLQUFLLElBQUksSUFBSSxHQUFHLEtBQUssS0FBSyxDQUFDO1FBQ25ELE1BQU0sSUFBSSxpQ0FBc0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMvQyxDQUFDO0FBTEQsc0NBS0M7QUFHRCxTQUFnQixjQUFjLENBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxXQUFXO0lBQ3RE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QztBQUMvQixDQUFDO0FBTEQsZ0RBS0M7QUFFRCxTQUFTLFVBQVUsQ0FBRSxHQUFHO0lBQ3BCLElBQUk7UUFDQSxPQUFPLElBQUksU0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQztLQUMvQjtJQUNELFdBQU07UUFDRixPQUFPLEtBQUssQ0FBQztLQUNoQjtBQUNMLENBQUM7QUFFRCxTQUFnQixZQUFZLENBQUUsSUFBSSxFQUFFLEdBQUc7SUFDbkMsTUFBTSxPQUFPLEdBQUcsa0JBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUUvQixLQUFLLE1BQU0sQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ3hDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDcEIsTUFBTSxPQUFPLENBQUMsTUFBTSxLQUFLLENBQUM7Z0JBQ3RCLENBQUMsQ0FBQyxJQUFJLHVDQUE0QixFQUFFO2dCQUNwQyxDQUFDLENBQUMsSUFBSSx3Q0FBNkIsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUM5QztLQUNKO0FBQ0wsQ0FBQztBQVZELG9DQVVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNWYWxpZERldmljZU5hbWUgfSBmcm9tICdkZXZpY2Utc3BlY3MnO1xuaW1wb3J0IHJvbGVNYXJrZXJTeW1ib2wgZnJvbSAnLi4vLi4vLi4vcm9sZS9tYXJrZXItc3ltYm9sJztcblxuaW1wb3J0IHtcbiAgICBjcmVhdGVCb29sZWFuVmFsaWRhdG9yLFxuICAgIGNyZWF0ZUludGVnZXJWYWxpZGF0b3IsXG4gICAgY3JlYXRlUG9zaXRpdmVJbnRlZ2VyVmFsaWRhdG9yLFxuICAgIGNyZWF0ZVNwZWVkVmFsaWRhdG9yLFxufSBmcm9tICcuL2ZhY3Rvcmllcyc7XG5cbmltcG9ydCB7XG4gICAgQWN0aW9uT3B0aW9uc1R5cGVFcnJvcixcbiAgICBBY3Rpb25Cb29sZWFuQXJndW1lbnRFcnJvcixcbiAgICBBY3Rpb25TdHJpbmdBcmd1bWVudEVycm9yLFxuICAgIEFjdGlvbk51bGxhYmxlU3RyaW5nQXJndW1lbnRFcnJvcixcbiAgICBBY3Rpb25JbnRlZ2VyQXJndW1lbnRFcnJvcixcbiAgICBBY3Rpb25Sb2xlQXJndW1lbnRFcnJvcixcbiAgICBBY3Rpb25Qb3NpdGl2ZUludGVnZXJBcmd1bWVudEVycm9yLFxuICAgIEFjdGlvblN0cmluZ09yU3RyaW5nQXJyYXlBcmd1bWVudEVycm9yLFxuICAgIEFjdGlvblN0cmluZ0FycmF5RWxlbWVudEVycm9yLFxuICAgIEFjdGlvblVuc3VwcG9ydGVkRGV2aWNlVHlwZUVycm9yLFxuICAgIEFjdGlvbkZ1bmN0aW9uQXJndW1lbnRFcnJvcixcbiAgICBTZXRUZXN0U3BlZWRBcmd1bWVudEVycm9yLFxuICAgIEZvcmJpZGRlbkNoYXJhY3RlcnNJblNjcmVlbnNob3RQYXRoRXJyb3IsXG4gICAgQWN0aW9uQ29va2llQXJndW1lbnRFcnJvcixcbiAgICBBY3Rpb25Db29raWVBcmd1bWVudHNFcnJvcixcbiAgICBBY3Rpb25VcmxDb29raWVBcmd1bWVudEVycm9yLFxuICAgIEFjdGlvblVybHNDb29raWVBcmd1bWVudEVycm9yLFxuICAgIEFjdGlvblJlcXVpcmVkQ29va2llQXJndW1lbnRzLFxufSBmcm9tICcuLi8uLi8uLi9lcnJvcnMvdGVzdC1ydW4nO1xuXG5pbXBvcnQgeyBVUkwgfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgYXNzZXJ0UGFnZVVybCB9IGZyb20gJy4uLy4uLy4uL2FwaS90ZXN0LXBhZ2UtdXJsJztcbmltcG9ydCBjaGVja0ZpbGVQYXRoIGZyb20gJy4uLy4uLy4uL3V0aWxzL2NoZWNrLWZpbGUtcGF0aCc7XG5pbXBvcnQgeyBjYXN0QXJyYXkgfSBmcm9tICdsb2Rhc2gnO1xuXG5cbi8vIFZhbGlkYXRvcnNcbmV4cG9ydCBjb25zdCBpbnRlZ2VyQXJndW1lbnQgICAgICAgICA9IGNyZWF0ZUludGVnZXJWYWxpZGF0b3IoQWN0aW9uSW50ZWdlckFyZ3VtZW50RXJyb3IpO1xuZXhwb3J0IGNvbnN0IHBvc2l0aXZlSW50ZWdlckFyZ3VtZW50ID0gY3JlYXRlUG9zaXRpdmVJbnRlZ2VyVmFsaWRhdG9yKEFjdGlvblBvc2l0aXZlSW50ZWdlckFyZ3VtZW50RXJyb3IpO1xuZXhwb3J0IGNvbnN0IGJvb2xlYW5Bcmd1bWVudCAgICAgICAgID0gY3JlYXRlQm9vbGVhblZhbGlkYXRvcihBY3Rpb25Cb29sZWFuQXJndW1lbnRFcnJvcik7XG5leHBvcnQgY29uc3Qgc2V0U3BlZWRBcmd1bWVudCAgICAgICAgPSBjcmVhdGVTcGVlZFZhbGlkYXRvcihTZXRUZXN0U3BlZWRBcmd1bWVudEVycm9yKTtcblxuXG5leHBvcnQgZnVuY3Rpb24gYWN0aW9uUm9sZUFyZ3VtZW50IChuYW1lLCB2YWwpIHtcbiAgICBpZiAoIXZhbCB8fCAhdmFsW3JvbGVNYXJrZXJTeW1ib2xdKVxuICAgICAgICB0aHJvdyBuZXcgQWN0aW9uUm9sZUFyZ3VtZW50RXJyb3IobmFtZSwgdHlwZW9mIHZhbCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3Rpb25PcHRpb25zIChuYW1lLCB2YWwpIHtcbiAgICBjb25zdCB0eXBlID0gdHlwZW9mIHZhbDtcblxuICAgIGlmICh0eXBlICE9PSAnb2JqZWN0JyAmJiB2YWwgIT09IG51bGwgJiYgdmFsICE9PSB2b2lkIDApXG4gICAgICAgIHRocm93IG5ldyBBY3Rpb25PcHRpb25zVHlwZUVycm9yKHR5cGUpO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBzdHJpbmdBcmd1bWVudCAoYXJndW1lbnQsIHZhbCwgY3JlYXRlRXJyb3IpIHtcbiAgICBpZiAoIWNyZWF0ZUVycm9yKVxuICAgICAgICBjcmVhdGVFcnJvciA9IGFjdHVhbFZhbHVlID0+IG5ldyBBY3Rpb25TdHJpbmdBcmd1bWVudEVycm9yKGFyZ3VtZW50LCBhY3R1YWxWYWx1ZSk7XG5cbiAgICBjb25zdCB0eXBlID0gdHlwZW9mIHZhbDtcblxuICAgIGlmICh0eXBlICE9PSAnc3RyaW5nJylcbiAgICAgICAgdGhyb3cgY3JlYXRlRXJyb3IodHlwZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub25FbXB0eVN0cmluZ0FyZ3VtZW50IChhcmd1bWVudCwgdmFsLCBjcmVhdGVFcnJvcikge1xuICAgIGlmICghY3JlYXRlRXJyb3IpXG4gICAgICAgIGNyZWF0ZUVycm9yID0gYWN0dWFsVmFsdWUgPT4gbmV3IEFjdGlvblN0cmluZ0FyZ3VtZW50RXJyb3IoYXJndW1lbnQsIGFjdHVhbFZhbHVlKTtcblxuICAgIHN0cmluZ0FyZ3VtZW50KGFyZ3VtZW50LCB2YWwsIGNyZWF0ZUVycm9yKTtcblxuICAgIGlmICghdmFsLmxlbmd0aClcbiAgICAgICAgdGhyb3cgY3JlYXRlRXJyb3IoJ1wiXCInKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG51bGxhYmxlU3RyaW5nQXJndW1lbnQgKGFyZ3VtZW50LCB2YWwpIHtcbiAgICBjb25zdCB0eXBlID0gdHlwZW9mIHZhbDtcblxuICAgIGlmICh0eXBlICE9PSAnc3RyaW5nJyAmJiB2YWwgIT09IG51bGwpXG4gICAgICAgIHRocm93IG5ldyBBY3Rpb25OdWxsYWJsZVN0cmluZ0FyZ3VtZW50RXJyb3IoYXJndW1lbnQsIHR5cGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXJsQXJndW1lbnQgKG5hbWUsIHZhbCkge1xuICAgIG5vbkVtcHR5U3RyaW5nQXJndW1lbnQobmFtZSwgdmFsKTtcblxuICAgIGFzc2VydFBhZ2VVcmwodmFsLnRyaW0oKSwgJ25hdmlnYXRlVG8nKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN0cmluZ09yU3RyaW5nQXJyYXlBcmd1bWVudCAoYXJndW1lbnQsIHZhbCkge1xuICAgIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsO1xuXG4gICAgaWYgKHR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGlmICghdmFsLmxlbmd0aClcbiAgICAgICAgICAgIHRocm93IG5ldyBBY3Rpb25TdHJpbmdPclN0cmluZ0FycmF5QXJndW1lbnRFcnJvcihhcmd1bWVudCwgJ1wiXCInKTtcbiAgICB9XG5cbiAgICBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHtcbiAgICAgICAgaWYgKCF2YWwubGVuZ3RoKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEFjdGlvblN0cmluZ09yU3RyaW5nQXJyYXlBcmd1bWVudEVycm9yKGFyZ3VtZW50LCAnW10nKTtcblxuICAgICAgICBjb25zdCB2YWxpZGF0ZUVsZW1lbnQgPSBlbGVtZW50SW5kZXggPT4gbm9uRW1wdHlTdHJpbmdBcmd1bWVudChcbiAgICAgICAgICAgIGFyZ3VtZW50LFxuICAgICAgICAgICAgdmFsW2VsZW1lbnRJbmRleF0sXG4gICAgICAgICAgICBhY3R1YWxWYWx1ZSA9PiBuZXcgQWN0aW9uU3RyaW5nQXJyYXlFbGVtZW50RXJyb3IoYXJndW1lbnQsIGFjdHVhbFZhbHVlLCBlbGVtZW50SW5kZXgpXG4gICAgICAgICk7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWwubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICB2YWxpZGF0ZUVsZW1lbnQoaSk7XG4gICAgfVxuXG4gICAgZWxzZVxuICAgICAgICB0aHJvdyBuZXcgQWN0aW9uU3RyaW5nT3JTdHJpbmdBcnJheUFyZ3VtZW50RXJyb3IoYXJndW1lbnQsIHR5cGUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVzaXplV2luZG93RGV2aWNlQXJndW1lbnQgKG5hbWUsIHZhbCkge1xuICAgIG5vbkVtcHR5U3RyaW5nQXJndW1lbnQobmFtZSwgdmFsKTtcblxuICAgIGlmICghaXNWYWxpZERldmljZU5hbWUodmFsKSlcbiAgICAgICAgdGhyb3cgbmV3IEFjdGlvblVuc3VwcG9ydGVkRGV2aWNlVHlwZUVycm9yKG5hbWUsIHZhbCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzY3JlZW5zaG90UGF0aEFyZ3VtZW50IChuYW1lLCB2YWwpIHtcbiAgICBub25FbXB0eVN0cmluZ0FyZ3VtZW50KG5hbWUsIHZhbCk7XG5cbiAgICBjb25zdCBmb3JiaWRkZW5DaGFyc0xpc3QgPSBjaGVja0ZpbGVQYXRoKHZhbCk7XG5cbiAgICBpZiAoZm9yYmlkZGVuQ2hhcnNMaXN0Lmxlbmd0aClcbiAgICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkNoYXJhY3RlcnNJblNjcmVlbnNob3RQYXRoRXJyb3IodmFsLCBmb3JiaWRkZW5DaGFyc0xpc3QpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZnVuY3Rpb25Bcmd1bWVudCAobmFtZSwgdmFsKSB7XG4gICAgaWYgKHR5cGVvZiB2YWwgIT09ICdmdW5jdGlvbicpXG4gICAgICAgIHRocm93IG5ldyBBY3Rpb25GdW5jdGlvbkFyZ3VtZW50RXJyb3IobmFtZSwgdmFsKTtcbn1cblxuZnVuY3Rpb24gaXNWYWxpZENvb2tpZSAoY29va2llKSB7XG4gICAgcmV0dXJuICEhY29va2llICYmICh0eXBlb2YgY29va2llID09PSAnb2JqZWN0JyB8fCB0eXBlb2YgY29va2llID09PSAnc3RyaW5nJyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb29raWVzQXJndW1lbnQgKG5hbWUsIHZhbCkge1xuICAgIGNvbnN0IGNvb2tpZXNMZW5ndGggPSB2YWwubGVuZ3RoO1xuXG4gICAgZm9yIChjb25zdCBbaSwgdmFsdWVdIG9mIHZhbC5lbnRyaWVzKCkpIHtcbiAgICAgICAgaWYgKCFpc1ZhbGlkQ29va2llKHZhbHVlKSkge1xuICAgICAgICAgICAgdGhyb3cgY29va2llc0xlbmd0aCA9PT0gMVxuICAgICAgICAgICAgICAgID8gbmV3IEFjdGlvbkNvb2tpZUFyZ3VtZW50RXJyb3IoKVxuICAgICAgICAgICAgICAgIDogbmV3IEFjdGlvbkNvb2tpZUFyZ3VtZW50c0Vycm9yKGkpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0Q29va2llc0FyZ3VtZW50IChuYW1lLCB2YWwpIHtcbiAgICBpZiAoIXZhbC5sZW5ndGgpXG4gICAgICAgIHRocm93IG5ldyBBY3Rpb25SZXF1aXJlZENvb2tpZUFyZ3VtZW50cygpO1xuXG4gICAgY29va2llc0FyZ3VtZW50KG5hbWUsIHZhbCk7XG59XG5cbmZ1bmN0aW9uIGlzVmFsaWRVcmwgKHVybCkge1xuICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBuZXcgVVJMKHVybCkgJiYgdHJ1ZTtcbiAgICB9XG4gICAgY2F0Y2gge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdXJsc0FyZ3VtZW50IChuYW1lLCB2YWwpIHtcbiAgICBjb25zdCBjYXN0VmFsID0gY2FzdEFycmF5KHZhbCk7XG5cbiAgICBmb3IgKGNvbnN0IFtpLCB2YWx1ZV0gb2YgY2FzdFZhbC5lbnRyaWVzKCkpIHtcbiAgICAgICAgaWYgKCFpc1ZhbGlkVXJsKHZhbHVlKSkge1xuICAgICAgICAgICAgdGhyb3cgY2FzdFZhbC5sZW5ndGggPT09IDFcbiAgICAgICAgICAgICAgICA/IG5ldyBBY3Rpb25VcmxDb29raWVBcmd1bWVudEVycm9yKClcbiAgICAgICAgICAgICAgICA6IG5ldyBBY3Rpb25VcmxzQ29va2llQXJndW1lbnRFcnJvcihpKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==